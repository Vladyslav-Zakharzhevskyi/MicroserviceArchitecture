version: '3.9'

services:
#  clients-postgres:
#    image: postgres:17.0
#    container_name: clients-postgres
#    environment:
#      POSTGRES_DB: clients
#      POSTGRES_USER: postgres
#      POSTGRES_PASSWORD: postgres
#    ports:
#      - "5431:5432"
#    volumes:
#      - ../client-service/src/main/resources/database:/docker-entrypoint-initdb.d:ro
#      - ./postgres-clients-data:/var/lib/postgresql/data
#    healthcheck:
#      test: [ "CMD-SHELL", "pg_isready -U postgres -p 5432" ]
#      interval: 10s
#      timeout: 5s
#      retries: 20

  products-postgres:
    image: postgres:17.0
    container_name: products-postgres
    environment:
      POSTGRES_DB: products
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5430:5432"
    volumes:
      - ../product-service/src/main/resources/database:/docker-entrypoint-initdb.d:ro
      - ./postgres-products-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -p 5432" ]
      interval: 10s
      timeout: 5s
      retries: 20

  product-service:
    build:
      context: ../product-service
      dockerfile: Dockerfile
    container_name: product-service
    ports:
      - "8091:2180"
    working_dir: /app
    environment:
      POSTGRES_HOST: products-postgres
      POSTGRES_PORT: 5432
      FEIGN_WAREHOUSE_SERVICE_URL: "http://warehouse-service:2222/api/v1/warehouse/availability"
      ALLOY_METRICS_SEND_URL: "http://alloy:4318/v1/metrics"
      ALLOY_TRACES_SEND_URL: "http://alloy:4317/v1/traces"
      SPRING_PROFILES_ACTIVE: docker
    depends_on:
      products-postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-i", "http://localhost:2180/actuator/health" ]
      interval: 5s
      timeout: 5s
      retries: 30

  warehouse-mongo:
    image: mongo:8.2
    container_name: warehouse-mongo
    environment:
      MONGO_INITDB_DATABASE: warehouse
      MONGO_INITDB_ROOT_USERNAME: mongo
      MONGO_INITDB_ROOT_PASSWORD: mongo
    ports:
      - "27016:27017"
    volumes:
      - ../warehouse-service/src/main/resources/database/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
      - ./mongo-warehouse-data:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping').ok" ]
      interval: 10s
      timeout: 5s
      retries: 5

  warehouse-service:
    build:
      context: ../warehouse-service
      dockerfile: Dockerfile
    container_name: warehouse-service
    ports:
      - "8090:2222"
    working_dir: /app
    environment:
      MONGO_HOST: warehouse-mongo
      MONGO_PORT: 27017
      ALLOY_METRICS_SEND_URL: "http://alloy:4318/v1/metrics"
      ALLOY_TRACES_SEND_URL: "http://alloy:4317/v1/traces"
      SPRING_PROFILES_ACTIVE: docker
    depends_on:
      warehouse-mongo:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-i", "http://localhost:2222/actuator/health" ]
      interval: 5s
      timeout: 5s
      retries: 30

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    ports:
      - "5400:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@gmail.com
      PGADMIN_DEFAULT_PASSWORD: admin
    volumes:
      - ./pgadmin-data:/var/lib/pgadmin

  mongo-express:
    image: mongo-express
    container_name: mongo-express
    ports:
      - "28081:8081"
    environment:
      ME_CONFIG_MONGODB_SERVER: warehouse-mongo
      ME_CONFIG_MONGODB_ADMINUSERNAME: mongo
      ME_CONFIG_MONGODB_ADMINPASSWORD: mongo
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    depends_on:
      - warehouse-mongo


  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    user: root
    ports:
      - "9090:9090"
    volumes:
      - ./static/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=365d'
      - '--storage.tsdb.retention.size=5GB'
      - '--web.enable-remote-write-receiver'
    depends_on:
      loki:
        condition: service_healthy

  grafana:
    image: grafana/grafana-enterprise
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - ./grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin

  products-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: products-postgres-exporter
    environment:
      DATA_SOURCE_URI: "products-postgres:5432/products?sslmode=disable"
      DATA_SOURCE_USER: "postgres"
      DATA_SOURCE_PASS_FILE: "/etc/config/pass.txt"
      PG_EXPORTER_DISABLE_DEFAULT_METRICS: true
      PG_EXPORTER_DISABLE_SETTINGS_METRICS: true
    volumes:
      - ./static/postgres-exporter/products/queries.yml:/etc/config/queries.yml:ro
      - ./static/postgres-exporter/products/pass.txt:/etc/config/pass.txt:ro
    depends_on:
      products-postgres:
        condition: service_healthy
    ports:
      - "9185:9187"
    command: ["--extend.query-path=/etc/config/queries.yml"]

  sql-products-db-metrics-exporter:
    image: githubfree/sql_exporter:latest
    container_name: sql-products-db-metrics-exporter
    volumes:
      - ./static/sql-metrics-exporter/sql_exporter.yml:/etc/config/sql_exporter.yml
      - ./static/sql-metrics-exporter/collectors/:/etc/config/collectors/
    depends_on:
      products-postgres:
        condition: service_healthy
    ports:
      - "9399:9399"
    command: ["-config.file=/etc/config/sql_exporter.yml"]

#  clients-postgres-exporter:
#    image: prometheuscommunity/postgres-exporter:latest
#    container_name: clients-postgres-exporter
#    environment:
#      DATA_SOURCE_URI: "clients-postgres:5432/clients?sslmode=disable"
#      DATA_SOURCE_USER: postgres
#      DATA_SOURCE_PASS: postgres
#    depends_on:
#      clients-postgres:
#        condition: service_healthy
#    ports:
#      - "9186:9187"

  warehouse-mongo-exporter:
    image: percona/mongodb_exporter:2.37
    container_name: warehouse-mongo-exporter
    environment:
      MONGODB_URI: mongodb://warehouse-mongo:27017/warehouse?authSource=admin
      AUTH_USER: mongo
      AUTH_PASS: mongo
    depends_on:
      warehouse-mongo:
        condition: service_healthy
    ports:
      - "9216:9216"

  alloy:
    image: grafana/alloy:v1.11.3
    container_name: grafana-alloy
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./alloy-data:/var/lib/alloy/data
      - ./static/alloy/config/config.alloy:/etc/alloy/config.alloy:ro
    environment:
      TEMPO_OTLP_ENDPOINT: http://tempo:4317
      PROMETHEUS_OTLP_ENDPOINT: http://prometheus:9090/api/v1/write
    ports:
      - "4319:4317" # OTLP/gRPC
      - "4320:4318" # OTLP/HTTP
      - "12345:12345"
    command: [ "run", "--server.http.listen-addr=0.0.0.0:12345", "--storage.path=/var/lib/alloy/data",
               "/etc/alloy/config.alloy" ]

  tempo:
    image: grafana/tempo:latest
    container_name: grafana-tempo
    ports:
      - "14268:14268" # jaeger ingest
      - "3200:3200" # tempo
      - "9095:9095" # tempo grpc
      - "4317:4317"
      - "4318:4318"
      - "9411:9411" # zipkin
    volumes:
      - ./tempo-data/var/tempo:/var/tempo
      - ./static/tempo/config/config.yml:/etc/tempo/config.yml:ro
    command: "-config.file=/etc/tempo/config.yml"

  loki:
    image: grafana/loki:3.5.7
    container_name: grafana-loki
    ports:
      - "3100:3100"
    volumes:
      - ./loki-data:/loki
      - ./static/loki/config/loki-config.yml:/etc/loki/config.yml:ro
    command: -config.file=/etc/loki/config.yml
    healthcheck:
      test: [ "CMD", "wget", "--spider", "http://localhost:3100/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5


volumes:
  postgres-clients-data:
  postgres-products-data:
  mongo-warehouse-data:
  prometheus-data:
  loki-data:
  alloy-data:
  tempo-data:
  grafana-data:
